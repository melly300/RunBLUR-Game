<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
  <title>Runner Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #101827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    canvas {
      display: block;
      background: #eaf4ff;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>

<script>
(function () {
  "use strict";

  // --- CANVAS & RESIZE -----------------------------------------------------
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  let width = 0;
  let height = 0;
  let groundY = 0;

  function resizeCanvas() {
    width =
      window.innerWidth ||
      document.documentElement.clientWidth ||
      document.body.clientWidth ||
      400;
    height =
      window.innerHeight ||
      document.documentElement.clientHeight ||
      document.body.clientHeight ||
      600;

    canvas.width = width;
    canvas.height = height;
    groundY = height * 0.82;
  }

  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // --- AUDIO SETUP ---------------------------------------------------------
  // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –æ–±—ä–µ–∫—Ç. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html
  const bgMusic = new Audio("Untitled Project 2.mp3");
  bgMusic.loop = true;   // –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ–º
  bgMusic.volume = 0.6;  // –≥—Ä–æ–º–∫–æ—Å—Ç—å 60%

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –º—É–∑—ã–∫–∏ (–±—Ä–∞—É–∑–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  function tryPlayMusic() {
    if (bgMusic.paused) {
      bgMusic.play().catch((err) => {
        console.warn("Autoplay blocked until user interaction:", err);
      });
    }
  }

  // --- GAME STATE ----------------------------------------------------------
  const GameState = {
    MENU: "menu",
    GAME: "game",
    PAUSE: "pause",
    SHOP: "shop",
    GAME_OVER: "gameover"
  };

  let gameState = GameState.MENU;

  // --- CONSTANTS -----------------------------------------------------------
  const GRAVITY = 2500; // px/s^2
  const BASE_RUN_SPEED = 430; // px/s at level 1
  const LEVEL_SCORE_STEP = 600; // —Å–∫–æ–ª—å–∫–æ –æ—á–∫–æ–≤ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å
  const OBSTACLE_MIN_INTERVAL = 1.2; // —Å–µ–∫
  const OBSTACLE_MAX_INTERVAL = 2.1; // —Å–µ–∫
  const COIN_OFFSET_X = 90; // px –æ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
  const COIN_HEIGHT_FACTOR = 0.16; // –≤—ã—Å–æ—Ç–∞ –º–æ–Ω–µ—Ç –Ω–∞–¥ –∑–µ–º–ª–µ–π
  const PLAYER_WIDTH = 36;
  const PLAYER_HEIGHT = 96;
  const POLICE_WIDTH = 34;
  const POLICE_HEIGHT = 94;

  const HAT_NONE = "none";
  const HAT_BANDANA = "bandana";
  const HAT_RED_CAP = "red_cap";
  const HAT_BLUE_CAP = "blue_cap";

  // --- PLAYER & POLICE -----------------------------------------------------
  const player = {
    x: () => width * 0.3,
    y: groundY,
    vy: 0,
    jumping: false,
    falling: false,
    onGround: true
  };

  const police = {
    x: () => width * 0.18,
    y: groundY,
    vy: 0
  };

  // --- WORLD OBJECTS -------------------------------------------------------
  const obstacles = [];
  const coins = [];

  let obstacleSpawnTimer = 0;
  let nextObstacleInterval = 1.5;
  let coinSpawnTimer = 0;

  // --- GAME VARIABLES ------------------------------------------------------
  let score = 0;
  let level = 1;
  let runSpeed = BASE_RUN_SPEED;
  let gameCoins = 0;
  let isGameOverTriggered = false;

  // background animation offsets
  let bgFarOffset = 0;
  let bgCityOffset = 0;

  // menu dancer animation
  let menuTime = 0;

  // --- SHOP / INVENTORY ----------------------------------------------------
  const inventory = [
    {
      id: HAT_BANDANA,
      name: "Bandana",
      price: 20,
      owned: false
    },
    {
      id: HAT_RED_CAP,
      name: "Red Cap",
      price: 40,
      owned: false
    },
    {
      id: HAT_BLUE_CAP,
      name: "Blue Cap",
      price: 60,
      owned: false
    }
  ];

  let equippedHat = HAT_NONE;

  // --- INPUT ---------------------------------------------------------------
  let pointerX = 0;
  let pointerY = 0;

  function getPointerPos(evt) {
    const rect = canvas.getBoundingClientRect();
    if (evt.touches && evt.touches.length > 0) {
      return {
        x: evt.touches[0].clientX - rect.left,
        y: evt.touches[0].clientY - rect.top
      };
    }
    return {
      x: evt.clientX - rect.left,
      y: evt.clientY - rect.top
    };
  }

  function handlePointerDown(evt) {
    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É –ø—Ä–∏ –ª—é–±–æ–º –∫–ª–∏–∫–µ
    tryPlayMusic();

    const pos = getPointerPos(evt);
    pointerX = pos.x;
    pointerY = pos.y;

    if (gameState === GameState.MENU) {
      handleMenuClick(pointerX, pointerY);
    } else if (gameState === GameState.SHOP) {
      handleShopClick(pointerX, pointerY);
    } else if (gameState === GameState.GAME) {
      if (isInsidePauseButton(pointerX, pointerY)) {
        togglePause();
      } else {
        playerJump();
      }
    } else if (gameState === GameState.PAUSE) {
      handlePauseClick(pointerX, pointerY);
    } else if (gameState === GameState.GAME_OVER) {
      resetGame();
      gameState = GameState.MENU;
    }
  }

  canvas.addEventListener("mousedown", handlePointerDown);
  canvas.addEventListener("touchstart", function (evt) {
    evt.preventDefault();
    handlePointerDown(evt);
  });

  document.addEventListener("keydown", function (evt) {
    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–ª–∞–≤–∏—à
    tryPlayMusic();

    if (evt.code === "Space" || evt.code === "ArrowUp") {
      if (gameState === GameState.GAME) {
        playerJump();
      }
    } else if (evt.code === "Escape") {
      if (gameState === GameState.GAME || gameState === GameState.PAUSE) {
        togglePause();
      }
    } else if (evt.code === "Enter") {
      if (gameState === GameState.GAME_OVER) {
        resetGame();
        gameState = GameState.MENU;
      }
    }
  });

  // --- BUTTON HELPERS ------------------------------------------------------
  function isInsideRect(x, y, rx, ry, rw, rh) {
    return x >= rx && x <= rx + rw && y >= ry && y <= ry + rh;
  }

  function isInsidePauseButton(x, y) {
    const size = 40;
    const margin = 16;
    const rx = width - size - margin;
    const ry = margin;
    return isInsideRect(x, y, rx, ry, size, size);
  }

  function handleMenuClick(x, y) {
    const buttonWidth = width * 0.4;
    const buttonHeight = 60;
    const centerX = width / 2;
    const startY = height * 0.55;

    const playRect = {
      x: centerX - buttonWidth / 2,
      y: startY,
      w: buttonWidth,
      h: buttonHeight
    };

    const shopRect = {
      x: centerX - buttonWidth / 2,
      y: startY + buttonHeight + 20,
      w: buttonWidth,
      h: buttonHeight
    };

    if (isInsideRect(x, y, playRect.x, playRect.y, playRect.w, playRect.h)) {
      resetGame();
      gameState = GameState.GAME;
    } else if (isInsideRect(x, y, shopRect.x, shopRect.y, shopRect.w, shopRect.h)) {
      gameState = GameState.SHOP;
    }
  }

  function handlePauseClick(x, y) {
    const buttonWidth = width * 0.3;
    const buttonHeight = 60;
    const centerX = width / 2;
    const centerY = height / 2;

    const continueRect = {
      x: centerX - buttonWidth / 2,
      y: centerY - buttonHeight / 2,
      w: buttonWidth,
      h: buttonHeight
    };

    if (isInsideRect(x, y, continueRect.x, continueRect.y, continueRect.w, continueRect.h)) {
      togglePause();
    }
  }

  function handleShopClick(x, y) {
    const margin = 40;
    const itemHeight = 80;
    const listTop = height * 0.3;
    const listLeft = margin;
    const listWidth = width - margin * 2;

    // Back button
    const backWidth = 120;
    const backHeight = 44;
    const backX = margin;
    const backY = margin;
    if (isInsideRect(x, y, backX, backY, backWidth, backHeight)) {
      gameState = GameState.MENU;
      return;
    }

    inventory.forEach(function (item, index) {
      const rowY = listTop + index * (itemHeight + 12);

      const buyWidth = 90;
      const buyHeight = 40;
      const buyX = listLeft + listWidth - buyWidth;
      const buyY = rowY + itemHeight / 2 - buyHeight / 2;

      if (isInsideRect(x, y, buyX, buyY, buyWidth, buyHeight)) {
        if (!item.owned) {
          if (gameCoins >= item.price) {
            gameCoins -= item.price;
            item.owned = true;
            equippedHat = item.id;
          }
        } else {
          // —É–∂–µ –∫—É–ø–ª–µ–Ω–æ -> —ç–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å
          equippedHat = item.id;
        }
      }
    });
  }

  function togglePause() {
    if (gameState === GameState.GAME) {
      gameState = GameState.PAUSE;
    } else if (gameState === GameState.PAUSE) {
      gameState = GameState.GAME;
    }
  }

  // --- PLAYER PHYSICS ------------------------------------------------------
  function playerJump() {
    if (player.onGround && !player.falling) {
      const baseJumpVelocity = -Math.max(750, height * 2.1);
      player.vy = baseJumpVelocity;
      player.onGround = false;
      player.jumping = true;
    }
  }

  function resetGame() {
    score = 0;
    level = 1;
    runSpeed = BASE_RUN_SPEED;
    obstacles.length = 0;
    coins.length = 0;
    obstacleSpawnTimer = 0;
    nextObstacleInterval = 1.5;
    coinSpawnTimer = 0;
    isGameOverTriggered = false;
    player.y = groundY;
    player.vy = 0;
    player.jumping = false;
    player.falling = false;
    player.onGround = true;
  }

  // --- SPAWN HELPERS -------------------------------------------------------
  function scheduleNextObstacle() {
    nextObstacleInterval =
      OBSTACLE_MIN_INTERVAL +
      Math.random() * (OBSTACLE_MAX_INTERVAL - OBSTACLE_MIN_INTERVAL);
  }

  function spawnObstacle() {
    const type = Math.random();
    let h;
    if (type < 0.33) {
      h = height * 0.08; // –Ω–∏–∑–∫–æ–µ
    } else if (type < 0.66) {
      h = height * 0.15; // –≤—ã—Å–æ–∫–æ–µ
    } else {
      h = height * 0.12; // –æ–±—ã—á–Ω–æ–µ
    }

    const w = width * 0.06;

    obstacles.push({
      x: width + w,
      y: groundY,
      w: w,
      h: h
    });

    // –º–æ–Ω–µ—Ç—ã –Ω–∞–¥/–ø–æ—Å–ª–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    const coinY = groundY - height * COIN_HEIGHT_FACTOR;
    const baseX = width + w + COIN_OFFSET_X;
    const coinCount = 2 + Math.floor(Math.random() * 3);
    for (let i = 0; i < coinCount; i++) {
      coins.push({
        x: baseX + i * 40,
        y: coinY - i * 4,
        r: 10
      });
    }
  }

  // --- UPDATE --------------------------------------------------------------
  function updateGame(delta) {
    if (gameState !== GameState.GAME) return;

    // —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —É—Ä–æ–≤–Ω–∏
    const targetLevel = 1 + Math.floor(score / LEVEL_SCORE_STEP);
    if (targetLevel !== level) {
      level = targetLevel;
    }
    const targetSpeed = BASE_RUN_SPEED * (1 + 0.1 * (level - 1));
    const lerpFactor = 3 * delta; // –ø–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    runSpeed = runSpeed + (targetSpeed - runSpeed) * Math.min(1, lerpFactor);

    const worldSpeed = runSpeed;

    // —Ñ–æ–Ω
    bgFarOffset -= worldSpeed * 0.15 * delta;
    bgCityOffset -= worldSpeed * 0.5 * delta;

    // –∏–≥—Ä–æ–∫
    player.vy += GRAVITY * delta;
    player.y += player.vy * delta;

    if (player.y >= groundY) {
      player.y = groundY;
      player.vy = 0;
      player.jumping = false;
      player.falling = false;
      player.onGround = true;
    } else {
      player.onGround = false;
    }

    // –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π
    police.y += (player.y - police.y) * 8 * delta;

    // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    for (let i = obstacles.length - 1; i >= 0; i--) {
      const o = obstacles[i];
      o.x -= worldSpeed * delta;

      if (o.x + o.w < -50) {
        obstacles.splice(i, 1);
        continue;
      }

      // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ
      const px = player.x();
      const pyTop = player.y - PLAYER_HEIGHT;
      const pyBottom = player.y;

      const oxLeft = o.x;
      const oxRight = o.x + o.w;
      const oyTop = o.y - o.h;

      if (
        px < oxRight &&
        px + PLAYER_WIDTH > oxLeft &&
        pyBottom > oyTop &&
        pyTop < o.y
      ) {
        if (!isGameOverTriggered) {
          isGameOverTriggered = true;
          player.falling = true;
          player.vy = -400;
          gameState = GameState.GAME_OVER;
        }
      }
    }

    // –º–æ–Ω–µ—Ç—ã
    for (let i = coins.length - 1; i >= 0; i--) {
      const c = coins[i];
      c.x -= worldSpeed * delta;
      if (c.x + c.r < -40) {
        coins.splice(i, 1);
        continue;
      }

      const px = player.x();
      const pyTop = player.y - PLAYER_HEIGHT;
      const pyBottom = player.y;

      if (
        px < c.x + c.r &&
        px + PLAYER_WIDTH > c.x - c.r &&
        pyBottom > c.y - c.r &&
        pyTop < c.y + c.r
      ) {
        gameCoins += 1;
        score += 30;
        coins.splice(i, 1);
      }
    }

    // —Å–ø–∞–≤–Ω –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
    obstacleSpawnTimer += delta;
    if (obstacleSpawnTimer >= nextObstacleInterval) {
      obstacleSpawnTimer = 0;
      scheduleNextObstacle();
      spawnObstacle();
    }

    // —Å—á—ë—Ç
    score += Math.floor(worldSpeed * delta * 0.08);
  }

  // --- DRAW: BACKGROUND ----------------------------------------------------
  function drawBackground() {
    // –¥–∞–ª—å–Ω–∏–π —Ñ–æ–Ω ‚Äî –Ω–µ–±–æ –∏ —Å–æ–ª–Ω—Ü–µ
    const farOffset = bgFarOffset % width;

    // –Ω–µ–±–æ
    const grad = ctx.createLinearGradient(0, 0, 0, height);
    grad.addColorStop(0, "#5b7fff");
    grad.addColorStop(1, "#bde7ff");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, width, height);

    // "–∫–∞—Ä—Ç–∏–Ω–∫–∞" –¥–∞–ª—å–Ω–µ–≥–æ —Ñ–æ–Ω–∞: —Ö–æ–ª–º—ã
    ctx.fillStyle = "#7cc0ff";
    for (let i = -1; i < 3; i++) {
      const baseX = i * width + farOffset * 0.6;
      ctx.beginPath();
      ctx.moveTo(baseX, height * 0.7);
      ctx.quadraticCurveTo(
        baseX + width * 0.25,
        height * 0.55,
        baseX + width * 0.5,
        height * 0.7
      );
      ctx.quadraticCurveTo(
        baseX + width * 0.75,
        height * 0.85,
        baseX + width,
        height * 0.7
      );
      ctx.lineTo(baseX + width, height);
      ctx.lineTo(baseX, height);
      ctx.closePath();
      ctx.fill();
    }

    // –≥–æ—Ä–æ–¥ (–¥–æ–º–∞) ‚Äî —Å—Ä–µ–¥–Ω–∏–π —Å–ª–æ–π
    const cityOffset = bgCityOffset % (width * 2);
    ctx.fillStyle = "#233657";
    const buildingWidth = 90;
    for (let i = -3; i < 8; i++) {
      const baseX = i * buildingWidth + cityOffset;
      const bHeight = height * (0.15 + (i % 5) * 0.05);
      ctx.fillRect(baseX, groundY - bHeight - 40, buildingWidth - 20, bHeight);
      // –æ–∫–Ω–∞
      ctx.fillStyle = "#f9f6e5";
      for (let wy = groundY - bHeight - 20; wy < groundY - 60; wy += 26) {
        ctx.fillRect(baseX + 10, wy, 12, 18);
        ctx.fillRect(baseX + 40, wy, 12, 18);
      }
      ctx.fillStyle = "#233657";
    }

    // –∑–µ–º–ª—è
    ctx.fillStyle = "#343a40";
    ctx.fillRect(0, groundY, width, height - groundY);
    ctx.fillStyle = "#555";
    ctx.fillRect(0, groundY, width, 6);

    // –ª–∏–Ω–∏—è –¥–æ—Ä–æ–≥–∏
    ctx.strokeStyle = "#999";
    ctx.lineWidth = 2;
    ctx.setLineDash([20, 20]);
    ctx.beginPath();
    ctx.moveTo(0, groundY + 40);
    ctx.lineTo(width, groundY + 40);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // --- DRAW: PLAYER & POLICE ----------------------------------------------
  function drawPlayer() {
    const px = player.x();
    const py = player.y;
    const runPhase = Math.sin(menuTime * 8 + score * 0.03);
    const legSwing = runPhase * 16;
    const armSwing = -runPhase * 18;
    const tilt = player.jumping ? -0.25 : (player.falling ? 0.6 : 0.0);

    ctx.save();
    ctx.translate(px, py - PLAYER_HEIGHT * 0.6);
    ctx.rotate(tilt);

    // –ù–û–ì–ò
    ctx.fillStyle = "#1e3a8a";
    drawLeg(-8, 32, legSwing);
    drawLeg(10, 32, -legSwing);

    // –¢–û–†–°
    ctx.fillStyle = "#2563eb";
    ctx.beginPath();
    ctx.roundRect(-14, -4, 28, 44, 10);
    ctx.fill();

    // –†–£–ö–ò
    ctx.fillStyle = "#2563eb";
    drawArm(-18, -2, armSwing);
    drawArm(18, -2, -armSwing);

    // –®–ï–Ø
    ctx.fillStyle = "#8d5524";
    ctx.fillRect(-4, -20, 8, 8);

    // –ì–û–õ–û–í–ê
    ctx.beginPath();
    ctx.arc(0, -32, 14, 0, Math.PI * 2);
    ctx.fill();

    // –õ–ò–¶–û
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(-5, -34, 2, 0, Math.PI * 2);
    ctx.arc(5, -34, 2, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.arc(-5, -34, 1, 0, Math.PI * 2);
    ctx.arc(5, -34, 1, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillRect(-2, -30, 4, 2); // –Ω–æ—Å

    // —Ä–æ—Ç
    ctx.strokeStyle = "#2c1810";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(0, -26, 5, 0, Math.PI);
    ctx.stroke();

    // –±–æ—Ä–æ–¥–∞
    ctx.fillStyle = "#2c1810";
    ctx.beginPath();
    ctx.arc(0, -27, 7, 0, Math.PI);
    ctx.fill();

    // –∑–æ–ª–æ—Ç–∞—è —Ü–µ–ø—å
    ctx.strokeStyle = "#ffd700";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(0, 10, 12, Math.PI * 0.1, Math.PI * 0.9);
    ctx.stroke();

    // –≠–ö–ò–ü–ò–†–û–í–ö–ê –ù–ê –ì–û–õ–û–í–ï
    drawHat(equippedHat);

    ctx.restore();
  }

  function drawLeg(offsetX, offsetY, swing) {
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.rotate((swing * Math.PI) / 180);
    ctx.fillRect(-4, 0, 8, 30);
    ctx.fillRect(-6, 26, 12, 6); // —Å—Ç–æ–ø–∞
    ctx.restore();
  }

  function drawArm(offsetX, offsetY, swing) {
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.rotate((swing * Math.PI) / 180);
    // –ø–ª–µ—á–æ
    ctx.fillRect(-3, 0, 6, 18);
    // –ø—Ä–µ–¥–ø–ª–µ—á—å–µ
    ctx.save();
    ctx.translate(0, 18);
    ctx.rotate((swing * 0.3 * Math.PI) / 180);
    ctx.fillRect(-3, 0, 6, 16);
    ctx.restore();
    ctx.restore();
  }

  function drawHat(hatId) {
    if (hatId === HAT_NONE) return;

    if (hatId === HAT_BANDANA) {
      ctx.fillStyle = "#dc2626";
      ctx.beginPath();
      ctx.moveTo(-14, -42);
      ctx.lineTo(14, -42);
      ctx.lineTo(12, -36);
      ctx.lineTo(-12, -36);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(10, -40);
      ctx.lineTo(16, -38);
      ctx.lineTo(12, -34);
      ctx.closePath();
      ctx.fill();
    } else if (hatId === HAT_RED_CAP) {
      ctx.fillStyle = "#ef4444";
      ctx.beginPath();
      ctx.arc(0, -40, 15, Math.PI, 0);
      ctx.fill();
      ctx.fillRect(-16, -40, 32, 5);
      ctx.fillRect(-4, -38, 14, 3); // –∫–æ–∑—ã—Ä—ë–∫
    } else if (hatId === HAT_BLUE_CAP) {
      ctx.fillStyle = "#1d4ed8";
      ctx.beginPath();
      ctx.arc(0, -40, 15, Math.PI, 0);
      ctx.fill();
      ctx.fillRect(-16, -40, 32, 5);
      ctx.fillStyle = "#1e40af";
      ctx.fillRect(-6, -38, 16, 3); // –∫–æ–∑—ã—Ä—ë–∫
    }
  }

  function drawPolice() {
    const px = police.x();
    const py = police.y;
    const runPhase = Math.sin(menuTime * 8 + score * 0.035 + 1.4);
    const legSwing = runPhase * 14;
    const armSwing = -runPhase * 16;

    ctx.save();
    ctx.translate(px, py - POLICE_HEIGHT * 0.6);

    // –Ω–æ–≥–∏
    ctx.fillStyle = "#1f2937";
    drawLeg(-7, 30, legSwing);
    drawLeg(9, 30, -legSwing);

    // —Ç–µ–ª–æ
    ctx.fillStyle = "#0f172a";
    ctx.beginPath();
    ctx.roundRect(-13, -2, 26, 42, 8);
    ctx.fill();

    // –∑–Ω–∞—á–æ–∫
    ctx.fillStyle = "#fbbf24";
    ctx.beginPath();
    ctx.arc(7, 6, 4, 0, Math.PI * 2);
    ctx.fill();

    // —Ä—É–∫–∏
    ctx.fillStyle = "#0f172a";
    drawArm(-18, 0, armSwing);
    drawArm(18, 0, -armSwing);

    // –¥—É–±–∏–Ω–∫–∞ –≤ –ø—Ä–∞–≤–æ–π —Ä—É–∫–µ
    ctx.save();
    ctx.translate(18, 10);
    ctx.rotate(-0.4);
    ctx.fillStyle = "#111827";
    ctx.fillRect(0, 0, 4, 22);
    ctx.restore();

    // —à–µ—è
    ctx.fillStyle = "#f1c27d";
    ctx.fillRect(-4, -20, 8, 8);

    // –≥–æ–ª–æ–≤–∞
    ctx.beginPath();
    ctx.arc(0, -32, 13, 0, Math.PI * 2);
    ctx.fill();

    // –ª–∏—Ü–æ (–∑–ª–æ–µ)
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.arc(-5, -34, 2, 0, Math.PI * 2);
    ctx.arc(5, -34, 2, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(-7, -36);
    ctx.lineTo(-3, -35);
    ctx.moveTo(3, -35);
    ctx.lineTo(7, -36);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(-4, -26);
    ctx.quadraticCurveTo(0, -30, 4, -26);
    ctx.stroke();

    // —Ñ—É—Ä–∞–∂–∫–∞
    ctx.fillStyle = "#020617";
    ctx.fillRect(-15, -46, 30, 6);
    ctx.fillRect(-9, -50, 18, 5);

    ctx.restore();
  }

  // --- DRAW: OBSTACLES & COINS --------------------------------------------
  function drawObstacles() {
    obstacles.forEach(function (o) {
      ctx.fillStyle = "#166534";
      ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
      ctx.fillStyle = "#22c55e";
      ctx.fillRect(o.x + 4, o.y - o.h + 8, o.w - 8, 10);
    });
  }

  function drawCoins() {
    coins.forEach(function (c) {
      const grad = ctx.createRadialGradient(
        c.x - 3,
        c.y - 3,
        2,
        c.x,
        c.y,
        c.r
      );
      grad.addColorStop(0, "#fff7c2");
      grad.addColorStop(1, "#facc15");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
      ctx.fill();

      ctx.strokeStyle = "#eab308";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r * 0.65, 0, Math.PI * 2);
      ctx.stroke();
    });
  }

  // --- DRAW: UI ------------------------------------------------------------
  function drawHUD() {
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillRect(0, 0, width, 52);

    ctx.fillStyle = "#ffffff";
    ctx.font = "16px system-ui, sans-serif";
    ctx.textBaseline = "middle";

    ctx.fillText("Score: " + score, 16, 18);
    ctx.fillText("Level: " + level, 16, 36);

    const coinsText = "Coins: " + gameCoins;
    const coinsWidth = ctx.measureText(coinsText).width;
    ctx.fillText(coinsText, width - coinsWidth - 16, 27);

    // pause button
    const size = 40;
    const margin = 6;
    const x = width - size - margin;
    const y = margin + 4;

    ctx.fillStyle = "rgba(15,23,42,0.85)";
    ctx.beginPath();
    ctx.roundRect(x, y, size, size, 10);
    ctx.fill();

    ctx.fillStyle = "#e5e7eb";
    ctx.fillRect(x + 12, y + 10, 4, 20);
    ctx.fillRect(x + 24, y + 10, 4, 20);
  }

  function drawPauseOverlay() {
    ctx.fillStyle = "rgba(15,23,42,0.7)";
    ctx.fillRect(0, 0, width, height);

    const buttonWidth = width * 0.3;
    const buttonHeight = 60;
    const centerX = width / 2;
    const centerY = height / 2;

    ctx.fillStyle = "#111827";
    ctx.beginPath();
    ctx.roundRect(
      centerX - buttonWidth / 2,
      centerY - buttonHeight / 2,
      buttonWidth,
      buttonHeight,
      16
    );
    ctx.fill();

    ctx.fillStyle = "#e5e7eb";
    ctx.font = "24px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("Continue", centerX, centerY);
  }

  function drawGameOverOverlay() {
    ctx.fillStyle = "rgba(15,23,42,0.7)";
    ctx.fillRect(0, 0, width, height);

    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 40px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("GAME OVER", width / 2, height * 0.4);

    ctx.font = "20px system-ui, sans-serif";
    ctx.fillText("Tap or press Enter to return to menu", width / 2, height * 0.55);
  }

  // --- DRAW: MENU & SHOP ---------------------------------------------------
  function drawMenu(delta) {
    drawBackground();

    // —Ç–∞–Ω—Ü—É—é—â–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤ –º–µ–Ω—é
    const centerX = width * 0.25;
    const baseY = groundY;
    const bounce = Math.sin(menuTime * 4) * 10;

    ctx.save();
    ctx.translate(centerX, baseY + bounce);
    ctx.scale(1.1, 1.1);
    drawPlayerSilhouette();
    ctx.restore();

    // –ª–æ–≥–æ—Ç–∏–ø / –∑–∞–≥–æ–ª–æ–≤–æ–∫
    ctx.fillStyle = "#0f172a";
    ctx.globalAlpha = 0.75;
    ctx.fillRect(0, 0, width, height * 0.32);
    ctx.globalAlpha = 1;

    ctx.fillStyle = "#f9fafb";
    ctx.font = "bold 32px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("RUNNER RAP", width / 2, height * 0.12);

    ctx.font = "16px system-ui, sans-serif";
    ctx.fillText("Tap Play to start the run", width / 2, height * 0.19);

    // –ö–ù–û–ü–ö–ò
    const buttonWidth = width * 0.4;
    const buttonHeight = 60;
    const centerX2 = width / 2;
    const startY = height * 0.55;

    // Play
    ctx.fillStyle = "#16a34a";
    ctx.beginPath();
    ctx.roundRect(
      centerX2 - buttonWidth / 2,
      startY,
      buttonWidth,
      buttonHeight,
      18
    );
    ctx.fill();

    ctx.fillStyle = "#ecfdf5";
    ctx.font = "22px system-ui, sans-serif";
    ctx.fillText("‚ñ∂ Play", centerX2, startY + buttonHeight / 2);

    // Shop
    ctx.fillStyle = "#1d4ed8";
    ctx.beginPath();
    ctx.roundRect(
      centerX2 - buttonWidth / 2,
      startY + buttonHeight + 20,
      buttonWidth,
      buttonHeight,
      18
    );
    ctx.fill();

    ctx.fillStyle = "#eff6ff";
    ctx.font = "22px system-ui, sans-serif";
    ctx.fillText("üõí Shop", centerX2, startY + buttonHeight + 20 + buttonHeight / 2);
  }

  function drawPlayerSilhouette() {
    // —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π, –Ω–æ –ø–æ—Ö–æ–∂–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
    const runPhase = Math.sin(menuTime * 6);
    const legSwing = runPhase * 18;
    const armSwing = -runPhase * 20;

    ctx.save();
    ctx.translate(0, -PLAYER_HEIGHT * 0.6);

    ctx.fillStyle = "#1e3a8a";
    drawLeg(-8, 32, legSwing);
    drawLeg(10, 32, -legSwing);

    ctx.fillStyle = "#1d4ed8";
    ctx.beginPath();
    ctx.roundRect(-14, -4, 28, 44, 10);
    ctx.fill();

    ctx.fillStyle = "#1d4ed8";
    drawArm(-18, -2, armSwing);
    drawArm(18, -2, -armSwing);

    ctx.fillStyle = "#fcd34d";
    ctx.strokeStyle = "#facc15";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(0, 10, 12, Math.PI * 0.1, Math.PI * 0.9);
    ctx.stroke();

    ctx.fillStyle = "#f59e0b";
    ctx.fillRect(-4, -20, 8, 8);
    ctx.beginPath();
    ctx.arc(0, -32, 14, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
  }

  function drawShop() {
    drawBackground();

    ctx.fillStyle = "rgba(15,23,42,0.9)";
    ctx.fillRect(0, 0, width, height);

    const margin = 40;
    const itemHeight = 80;
    const listTop = height * 0.3;
    const listLeft = margin;
    const listWidth = width - margin * 2;

    // –∑–∞–≥–æ–ª–æ–≤–æ–∫
    ctx.fillStyle = "#e5e7eb";
    ctx.font = "bold 28px system-ui, sans-serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText("Shop", margin, margin);

    // –º–æ–Ω–µ—Ç—ã –∏–≥—Ä–æ–∫–∞
    ctx.font = "18px system-ui, sans-serif";
    ctx.fillText("Your coins: " + gameCoins, margin, margin + 32);

    // –∫–Ω–æ–ø–∫–∞ Back
    const backWidth = 120;
    const backHeight = 44;
    ctx.fillStyle = "#1d4ed8";
    ctx.beginPath();
    ctx.roundRect(margin, margin + 60, backWidth, backHeight, 12);
    ctx.fill();
    ctx.fillStyle = "#eff6ff";
    ctx.font = "18px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("Back", margin + backWidth / 2, margin + 60 + backHeight / 2);

    // —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    ctx.textAlign = "left";
    inventory.forEach(function (item, index) {
      const y = listTop + index * (itemHeight + 12);

      ctx.fillStyle = "rgba(31,41,55,0.9)";
      ctx.beginPath();
      ctx.roundRect(listLeft, y, listWidth, itemHeight, 16);
      ctx.fill();

      // –∏–∫–æ–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
      ctx.save();
      ctx.translate(listLeft + 40, y + itemHeight / 2);
      ctx.scale(1.1, 1.1);
      if (item.id === HAT_BANDANA) {
        ctx.fillStyle = "#dc2626";
        ctx.beginPath();
        ctx.arc(0, 0, 14, Math.PI, 0);
        ctx.fill();
      } else if (item.id === HAT_RED_CAP) {
        ctx.fillStyle = "#ef4444";
        ctx.beginPath();
        ctx.arc(0, 0, 14, Math.PI, 0);
        ctx.fill();
      } else if (item.id === HAT_BLUE_CAP) {
        ctx.fillStyle = "#1d4ed8";
        ctx.beginPath();
        ctx.arc(0, 0, 14, Math.PI, 0);
        ctx.fill();
      }
      ctx.restore();

      // —Ç–µ–∫—Å—Ç
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "20px system-ui, sans-serif";
      ctx.fillText(item.name, listLeft + 80, y + 20);

      ctx.font = "16px system-ui, sans-serif";
      ctx.fillStyle = "#9ca3af";
      ctx.fillText("Price: " + item.price + " coins", listLeft + 80, y + 46);

      // BUY / EQUIP
      const buyWidth = 90;
      const buyHeight = 40;
      const buyX = listLeft + listWidth - buyWidth - 16;
      const buyY = y + itemHeight / 2 - buyHeight / 2;

      if (!item.owned) {
        ctx.fillStyle = gameCoins >= item.price ? "#16a34a" : "#4b5563";
        ctx.beginPath();
        ctx.roundRect(buyX, buyY, buyWidth, buyHeight, 10);
        ctx.fill();
        ctx.fillStyle = "#e5e7eb";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "18px system-ui, sans-serif";
        ctx.fillText("Buy", buyX + buyWidth / 2, buyY + buyHeight / 2);
      } else {
        const equipped = equippedHat === item.id;
        ctx.fillStyle = equipped ? "#22c55e" : "#64748b";
        ctx.beginPath();
        ctx.roundRect(buyX, buyY, buyWidth, buyHeight, 10);
        ctx.fill();
        ctx.fillStyle = "#e5e7eb";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "16px system-ui, sans-serif";
        ctx.fillText(equipped ? "Equipped" : "Wear", buyX + buyWidth / 2, buyY + buyHeight / 2);
      }
    });
  }

  // --- MAIN LOOP -----------------------------------------------------------
  let lastTime = 0;

  function loop(timestamp) {
    if (!lastTime) lastTime = timestamp;
    const delta = Math.min(0.05, (timestamp - lastTime) / 1000); // clamp
    lastTime = timestamp;
    menuTime += delta;

    ctx.clearRect(0, 0, width, height);

    if (gameState === GameState.MENU) {
      drawMenu(delta);
    } else if (gameState === GameState.SHOP) {
      drawShop();
    } else if (gameState === GameState.GAME || gameState === GameState.PAUSE || gameState === GameState.GAME_OVER) {
      if (gameState === GameState.GAME) {
        updateGame(delta);
      }
      drawBackground();
      drawObstacles();
      drawCoins();
      drawPolice();
      drawPlayer();
      drawHUD();

      if (gameState === GameState.PAUSE) {
        drawPauseOverlay();
      } else if (gameState === GameState.GAME_OVER) {
        drawGameOverOverlay();
      }
    }

    requestAnimationFrame(loop);
  }

  resetGame();
  scheduleNextObstacle();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
