<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Street Runner: Realism Update</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Courier New', Courier, monospace;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #fff;
      text-shadow: 2px 2px 0 #000;
      pointer-events: none;
      z-index: 10;
    }
    .hud-line {
      font-size: 20px;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #start-screen {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 20;
    }
    button {
      padding: 15px 40px;
      font-size: 24px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 4px #991b1b;
    }
    button:active {
      box-shadow: 0 0 #991b1b;
      transform: translateY(4px);
    }
  </style>
</head>
<body>

<div id="ui" style="display:none;">
  <div class="hud-line" id="scoreEl">SCORE: 0</div>
  <div class="hud-line" id="levelEl">LEVEL: 1</div>
  <div class="hud-line" id="speedEl">SPEED: 100%</div>
</div>

<div id="start-screen">
  <h1 style="font-size: 50px; text-transform: uppercase; color: #facc15;">Night Run</h1>
  <p>Tap PLAY to start Music & Game</p>
  <button id="startBtn">PLAY NOW</button>
</div>

<canvas id="game"></canvas>

<script>
// --- TEXTURE GENERATOR (Procedural Textures) ---
// Создаем текстуры "на лету", чтобы не качать картинки, но получить детализацию
function createAsphaltPattern() {
  const c = document.createElement('canvas');
  c.width = 128; c.height = 128;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#1f2937'; // Темно-серый
  ctx.fillRect(0,0,128,128);
  // Шум (зерно)
  for(let i=0; i<1000; i++) {
    ctx.fillStyle = Math.random() > 0.5 ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.2)';
    ctx.fillRect(Math.random()*128, Math.random()*128, 2, 2);
  }
  return c;
}

function createBrickPattern() {
  const c = document.createElement('canvas');
  c.width = 64; c.height = 64;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#7f1d1d'; // Темно-красный кирпич
  ctx.fillRect(0,0,64,64);
  ctx.strokeStyle = '#450a0a'; // Швы
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0,32); ctx.lineTo(64,32);
  ctx.moveTo(32,0); ctx.lineTo(32,32);
  ctx.moveTo(0,0); ctx.lineTo(0,64);
  ctx.stroke();
  // Грязь
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.fillRect(0, 50, 64, 14);
  return c;
}

// --- GAME ENGINE ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// Аудио
const audio = new Audio('Untitled Project 2.mp3');
audio.loop = true;
audio.volume = 0.6;

// Переменные
let w, h;
let asphaltPattern, brickPattern;
let animationId;
let isPlaying = false;
let frames = 0;

// Геймплейные константы
const GRAVITY = 2500;
const BASE_SPEED = 600; // Пикселей в секунду (Базовая скорость)
const JUMP_FORCE = 900;

// Состояние игры
let state = {
  score: 0,
  level: 1,
  speedMultiplier: 1.0,
  speed: BASE_SPEED,
  gameTime: 0
};

// Объекты
const player = {
  x: 100, y: 0, w: 40, h: 100,
  vy: 0,
  grounded: false,
  color: '#3b82f6'
};

const police = {
  x: -150, y: 0, w: 45, h: 105,
  offset: 200 // Дистанция отставания
};

let obstacles = [];
let particles = [];
let groundY = 0;

// --- INITIALIZATION ---
function init() {
  resize();
  window.addEventListener('resize', resize);
  
  // Создаем текстуры
  const asp = createAsphaltPattern();
  asphaltPattern = ctx.createPattern(asp, 'repeat');
  
  const brk = createBrickPattern();
  brickPattern = ctx.createPattern(brk, 'repeat');

  // Управление
  window.addEventListener('keydown', e => {
    if (e.code === 'Space' || e.code === 'ArrowUp') jump();
  });
  window.addEventListener('touchstart', e => {
    e.preventDefault();
    jump();
  });
  window.addEventListener('mousedown', jump);

  document.getElementById('startBtn').addEventListener('click', startGame);
}

function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
  groundY = h - 150;
  player.y = groundY;
}

function startGame() {
  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('ui').style.display = 'block';
  
  // ЗАПУСК МУЗЫКИ (Обязательно внутри user interaction)
  audio.play().catch(e => console.error("Audio play failed", e));
  
  resetGame();
  isPlaying = true;
  lastTime = performance.now();
  requestAnimationFrame(loop);
}

function resetGame() {
  state.score = 0;
  state.level = 1;
  state.speedMultiplier = 1.0;
  state.speed = BASE_SPEED;
  state.gameTime = 0;
  
  player.y = groundY;
  player.vy = 0;
  
  police.x = -150;
  obstacles = [];
  particles = [];
}

function jump() {
  if (!isPlaying) {
    if (frames > 10) startGame(); // Restart if game over
    return;
  }
  if (player.grounded) {
    player.vy = -JUMP_FORCE;
    player.grounded = false;
    spawnParticles(player.x, player.y, 10, '#fff');
  }
}

// --- LOGIC ---
let lastTime = 0;
let obstacleTimer = 0;

function update(dt) {
  state.gameTime += dt;
  
  // 1. ОБНОВЛЕНИЕ УРОВНЯ И СКОРОСТИ (По ТЗ)
  // Каждые 100 очков -> +1 Уровень -> Скорость растет
  // Math.floor(score / 100) + 1. 
  // 0-99 = lvl 1, 100-199 = lvl 2
  
  let targetLevel = Math.floor(state.score / 100) + 1;
  
  if (targetLevel > state.level) {
    state.level = targetLevel;
    // Эффект Level UP
    spawnParticles(w/2, h/2, 20, '#fbbf24'); 
  }

  // Формула: Скорость = 1 + (Level - 1) * 0.1
  // Lvl 1 -> 1.0, Lvl 2 -> 1.1, Lvl 3 -> 1.2
  state.speedMultiplier = 1 + (state.level - 1) * 0.1;
  
  // Плавное применение скорости
  let targetSpeed = BASE_SPEED * state.speedMultiplier;
  state.speed += (targetSpeed - state.speed) * dt * 2; // lerp

  // Начисление очков (зависит от времени и скорости)
  state.score += (state.speed / 100) * dt;

  // 2. ИГРОК
  player.vy += GRAVITY * dt;
  player.y += player.vy * dt;
  
  if (player.y >= groundY) {
    player.y = groundY;
    player.vy = 0;
    player.grounded = true;
  } else {
    player.grounded = false;
  }

  // 3. ПОЛИЦИЯ (Догоняет или отстает)
  let targetPoliceX = player.x - state.speedMultiplier * 200; 
  if (targetPoliceX > -50) targetPoliceX = -50; // Не ближе чем
  police.x += (targetPoliceX - police.x) * dt;

  // 4. ПРЕПЯТСТВИЯ
  obstacleTimer -= dt;
  if (obstacleTimer <= 0) {
    spawnObstacle();
    // Чем выше уровень, тем чаще препятствия, но не невозможно
    let minT = 1.0 / (state.speedMultiplier * 0.8); 
    obstacleTimer = minT + Math.random() * minT;
  }

  obstacles.forEach((obs, i) => {
    obs.x -= state.speed * dt;
    
    // Коллизия (упрощенная)
    if (player.x < obs.x + obs.w &&
        player.x + player.w > obs.x &&
        player.y > groundY - obs.h + 10) { // +10 прощает чуть-чуть
      gameOver();
    }
  });
  
  // Удаление старых препятствий
  obstacles = obstacles.filter(o => o.x > -100);

  // Частицы
  particles.forEach(p => {
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.life -= dt * 2;
  });
  particles = particles.filter(p => p.life > 0);
  
  // UI Update
  document.getElementById('scoreEl').innerText = `SCORE: ${Math.floor(state.score)}`;
  document.getElementById('levelEl').innerText = `LEVEL: ${state.level}`;
  document.getElementById('speedEl').innerText = `SPEED: x${state.speedMultiplier.toFixed(1)}`;
}

function spawnObstacle() {
  const type = Math.random();
  let obs = { x: w, w: 50, h: 50, type: 'box' };
  
  if (type > 0.6) {
    obs.h = 80; obs.w = 60; obs.type = 'trash'; // Высокое
  } else {
    obs.h = 40; obs.w = 40; obs.type = 'crate'; // Низкое
  }
  obstacles.push(obs);
}

function spawnParticles(x, y, count, color) {
  for(let i=0; i<count; i++) {
    particles.push({
      x: x, y: y,
      vx: (Math.random() - 0.5) * 400,
      vy: (Math.random() - 0.5) * 400,
      life: 1.0,
      color: color
    });
  }
}

function gameOver() {
  isPlaying = false;
  frames = 0; // reset counter for click debounce
  
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle = 'red';
  ctx.font = 'bold 60px Courier New';
  ctx.textAlign = 'center';
  ctx.fillText('BUSTED', w/2, h/2);
  ctx.fillStyle = 'white';
  ctx.font = '20px Courier New';
  ctx.fillText('Tap to Restart', w/2, h/2 + 50);
}

// --- RENDERING (Graphics Update) ---
function draw() {
  if (!isPlaying && frames > 5) return; // Stop drawing if game over
  
  // 1. Небо (Градиент)
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, '#0f172a'); // Ночь
  grad.addColorStop(1, '#312e81'); // Горизонт
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, h);

  // 2. Параллакс фона (Город)
  ctx.fillStyle = '#000';
  let bgOffset = (state.score * 20) % 200;
  for(let i=0; i<w/50 + 2; i++) {
    let bh = 100 + Math.sin(i * 1321) * 80; // Хаотичная высота
    let bx = (i * 50) - bgOffset;
    ctx.fillRect(bx, groundY - bh, 52, bh);
    
    // Окна (свет)
    ctx.fillStyle = Math.sin(i) > 0 ? '#fef3c7' : '#4b5563'; 
    if (i%2===0) ctx.fillRect(bx+10, groundY - bh + 20, 10, 10);
    ctx.fillStyle = '#000';
  }

  // 3. Земля (Текстура асфальта)
  ctx.save();
  ctx.translate(-(state.gameTime * state.speed) % 128, 0);
  ctx.fillStyle = asphaltPattern;
  ctx.fillRect(0, groundY, w + 128, h - groundY);
  ctx.restore();

  // Разметка
  ctx.save();
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(255,255,255,0.6)';
  ctx.lineWidth = 6;
  ctx.setLineDash([60, 80]);
  ctx.lineDashOffset = -(state.gameTime * state.speed);
  ctx.moveTo(0, groundY + 40);
  ctx.lineTo(w, groundY + 40);
  ctx.stroke();
  ctx.restore();

  // 4. Препятствия (С текстурами)
  obstacles.forEach(o => {
    if (o.type === 'trash') {
      ctx.fillStyle = '#064e3b'; // Зеленый бак
      ctx.fillRect(o.x, groundY - o.h, o.w, o.h);
      ctx.fillStyle = 'rgba(255,255,255,0.1)';
      ctx.fillRect(o.x, groundY - o.h, 5, o.h); // Блик
      // Полоски
      ctx.fillStyle = '#022c22';
      ctx.fillRect(o.x, groundY - o.h + 20, o.w, 5);
    } else {
      ctx.fillStyle = brickPattern; // Кирпичный блок
      ctx.fillRect(o.x, groundY - o.h, o.w, o.h);
      ctx.strokeStyle = '#000';
      ctx.strokeRect(o.x, groundY - o.h, o.w, o.h);
    }
  });

  // 5. Персонажи (Новая рисовка)
  drawCharacter(player.x, player.y, true);
  drawCharacter(police.x, police.y, false);

  // 6. Частицы
  particles.forEach(p => {
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1.0;
  });
}

// Продвинутая отрисовка персонажа
function drawCharacter(x, y, isPlayer) {
  const anim = Math.sin(state.gameTime * 15 * state.speedMultiplier); // Цикл бега
  const tilt = isPlayer ? 0.3 : 0.1;
  
  ctx.save();
  ctx.translate(x + 20, y); // Центр снизу
  ctx.rotate(tilt); // Наклон вперед от скорости

  // Тени
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.beginPath(); ctx.ellipse(0, 0, 20, 5, 0, 0, Math.PI*2); ctx.fill();

  // Ноги
  ctx.lineWidth = 8;
  ctx.lineCap = 'round';
  ctx.strokeStyle = isPlayer ? '#1e40af' : '#111827';
  
  // Левая нога
  ctx.beginPath();
  ctx.moveTo(0, -40);
  ctx.lineTo(Math.sin(anim)*20, -10 + Math.cos(anim)*5);
  ctx.stroke();
  
  // Правая нога
  ctx.beginPath();
  ctx.moveTo(0, -40);
  ctx.lineTo(Math.sin(anim + Math.PI)*20, -10 + Math.cos(anim + Math.PI)*5);
  ctx.stroke();

  // Тело
  ctx.fillStyle = isPlayer ? '#3b82f6' : '#1f2937'; // Синий / Темный
  // Худи для игрока
  ctx.beginPath();
  ctx.moveTo(-10, -40);
  ctx.lineTo(10, -40);
  ctx.lineTo(12, -75);
  ctx.lineTo(-12, -75);
  ctx.fill();

  // Голова
  ctx.fillStyle = '#fcd34d'; // Кожа
  ctx.beginPath(); ctx.arc(0, -80, 12, 0, Math.PI*2); ctx.fill();
  
  // Кепка / Фуражка
  if (isPlayer) {
    ctx.fillStyle = '#ef4444'; // Красная кепка
    ctx.fillRect(-12, -88, 24, 6);
    ctx.fillRect(0, -88, 20, 4); // Козырек
  } else {
    ctx.fillStyle = '#1e3a8a'; // Фуражка
    ctx.fillRect(-14, -90, 28, 10);
    ctx.fillStyle = 'gold'; // Значок
    ctx.fillRect(-2, -90, 4, 4);
  }

  // Руки
  ctx.strokeStyle = isPlayer ? '#60a5fa' : '#374151';
  ctx.beginPath();
  ctx.moveTo(0, -70);
  ctx.lineTo(Math.sin(anim + Math.PI)*20, -40);
  ctx.stroke();

  // Дубинка у копа
  if (!isPlayer) {
    ctx.save();
    ctx.translate(Math.sin(anim + Math.PI)*20, -40);
    ctx.rotate(-1);
    ctx.fillStyle = '#333';
    ctx.fillRect(-2, 0, 4, 25);
    ctx.restore();
  }

  ctx.restore();
}

function loop() {
  if (!isPlaying) return;
  frames++;
  
  const now = performance.now();
  const dt = Math.min((now - lastTime) / 1000, 0.1);
  lastTime = now;
  
  update(dt);
  draw();
  
  requestAnimationFrame(loop);
}

// Запуск
init();

</script>
</body>
</html>
